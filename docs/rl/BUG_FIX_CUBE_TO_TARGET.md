# ğŸ› Critical Bug Fix: Cube-to-Target Index Error

**ì¼ì**: 2025-10-20  
**ë²„ì „**: V5 (Post-V4 Critical Fix)  
**ì‘ì„±ì**: AI Assistant + User

---

## ğŸ“‹ ìš”ì•½

**í•µì‹¬ ë²„ê·¸**: ê´€ì¸¡ ë²¡í„°ì—ì„œ `cube_to_target` ì¸ë±ìŠ¤ë¥¼ **ì˜ëª» ì‚¬ìš©**í•˜ì—¬ ì„±ê³µ íŒì •ì´ ì „í˜€ ì‘ë™í•˜ì§€ ì•ŠìŒ.

**ê²°ê³¼**: 
- âœ… ëª¨ë“  ì—í”¼ì†Œë“œê°€ TimeLimit(600)ìœ¼ë¡œ ì¢…ë£Œ
- âŒ SUCCESS ì¡°ê±´ì´ ì ˆëŒ€ ì°¸ì´ ë  ìˆ˜ ì—†ìŒ
- âŒ ì¡°ê¸° ì¢…ë£Œ ë¶ˆê°€ëŠ¥ (l<600 ì—í”¼ì†Œë“œ ì—†ìŒ)

**ìˆ˜ì •**: 
- `obs[20:23]` (cube_velocity) â†’ `obs[14:17]` (cube_to_target)
- ì›”ë“œ ì¢Œí‘œë¡œ ì¬ê³„ì‚°í•˜ì—¬ ì‹ ë¢°ë„ â†‘

---

## ğŸ” ë¬¸ì œ ë¶„ì„

### ê´€ì¸¡ ë²¡í„° êµ¬ì„± (28 dim)

```python
0:6   joints(6)
6:8   gripper(2)
8:11  cube_rel_to_ee(3)      # EE â†’ Cube ë²¡í„°
11:14 target_rel_to_ee(3)    # EE â†’ Target ë²¡í„°
14:17 cube_to_target(3)      # âœ… Cube â†’ Target ë²¡í„° (ì •ë‹µ ìœ„ì¹˜!)
17:20 ee_velocity(3)
20:23 cube_velocity(3)        # âŒ ì˜ëª» ì‚¬ìš©ëœ ì¸ë±ìŠ¤ (ì†ë„!)
23    gripper_width
24    is_grasped
25    dist_to_cube
26    dist_cube_to_target
27    previous_reward
```

### ë²„ê·¸ ìœ„ì¹˜

**1. `step()` í•¨ìˆ˜ (line 530)**
```python
# ğŸ› BUG: cube_velocityë¥¼ cube_to_targetë¡œ ì°©ê°
cube_to_target_dist = np.linalg.norm(obs[20:23])  # âŒ ì˜ëª»ëœ ì¸ë±ìŠ¤!
```

**2. `_check_done()` í•¨ìˆ˜ (line 697)**
```python
# ğŸ› BUG: cube_velocityë¥¼ cube_to_targetë¡œ ì°©ê°
cube_to_target_vec = obs[20:23]  # âŒ ì˜ëª»ëœ ì¸ë±ìŠ¤!
cube_to_target_dist = np.linalg.norm(cube_to_target_vec)
```

### ì˜í–¥

1. **ì„±ê³µ ì¡°ê±´ ë¯¸ì‘ë™**:
   - `cube_velocity`ëŠ” ë³´í†µ ì‘ì€ ê°’ (< 0.1m/s)
   - `success_threshold = 0.02m` (2cm)
   - **ì†ë„ê°€ ê±°ë¦¬ ì„ê³„ì¹˜ë³´ë‹¤ ì‘ì•„ ì„±ê³µ íŒì •ì´ ìš°ì—°íˆ ë°œìƒ**í•  ìˆ˜ ìˆì§€ë§Œ, **íë¸Œê°€ ì‹¤ì œë¡œ íƒ€ê²Ÿì— ë„ë‹¬í•˜ì§€ ì•Šì•„ë„ ì„±ê³µìœ¼ë¡œ ì˜ëª» íŒë‹¨**

2. **TimeLimit 100%**:
   - V4 10K í…ŒìŠ¤íŠ¸: 17/17 episodes ëª¨ë‘ l=600 (TimeLimit)
   - ì¡°ê¸° ì¢…ë£Œ ë¶ˆê°€ëŠ¥

3. **í•™ìŠµ íš¨ìœ¨ ì €í•˜**:
   - ì •ì±…ì´ ì‹¤ì œ ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ë¥¼ í•™ìŠµí•˜ì§€ ëª»í•¨
   - Dense ë³´ìƒë§Œìœ¼ë¡œ í•™ìŠµ (Sparse ì´ë²¤íŠ¸ ë³´ìƒ ë¯¸ì‘ë™)

---

## âœ… ìˆ˜ì • ì‚¬í•­

### 1. ì˜¬ë°”ë¥¸ ì¸ë±ìŠ¤ ì‚¬ìš© + ì›”ë“œ ì¢Œí‘œ ì¬ê³„ì‚°

**`step()` í•¨ìˆ˜**:
```python
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š ë¡œê¹…: ì´ë²¤íŠ¸ ë° ì§„í–‰ ìƒí™© ì¶”ì 
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ BUG FIX: ì˜¬ë°”ë¥¸ ì¸ë±ìŠ¤ ì‚¬ìš© (14:17 = cube_to_target ë²¡í„°)
# ë” ì‹ ë¢°ë„ ë†’ì€ ë°©ë²•: ì›”ë“œ ì¢Œí‘œë¡œ ì¬ê³„ì‚°
cube_pos, _ = self.cube.get_world_pose()
target_pos = np.array(self.cfg.target_position)
cube_to_target_dist = float(np.linalg.norm(target_pos - cube_pos))
```

**`_check_done()` í•¨ìˆ˜**:
```python
# ğŸ”§ BUG FIX: ì›”ë“œ ì¢Œí‘œë¡œ ì •í™•í•˜ê²Œ ì¬ê³„ì‚°
cube_pos, _ = self.cube.get_world_pose()
target_pos = np.array(self.cfg.target_position)
cube_to_target_dist = float(np.linalg.norm(target_pos - cube_pos))

# ê´€ì¸¡ ë²¡í„°ì˜ íë¸Œ ìœ„ì¹˜ë„ ì°¸ê³  (ë””ë²„ê¹…ìš©)
cube_pos_obs = obs[11:14]
```

### 2. ë³´ìƒ ì‹œìŠ¤í…œ ê°œì„  (Î”í˜• - ê°œì„ ëŸ‰ ê¸°ë°˜)

**ë¬¸ì œ**: Dense ë³´ìƒì´ `-dist * (3 ë˜ëŠ” 2)` í˜•íƒœë¼ 600ìŠ¤í… ëˆ„ì  ì‹œ -300~-600ëŒ€ë¡œ ì‰½ê²Œ ì»¤ì§.

**í•´ê²°**: ì ˆëŒ€ê°’ ëŒ€ì‹  **ê°œì„ ëŸ‰(Î”)** ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½:
```python
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ A. DENSE REWARD (Î”í˜• - ê°œì„ ëŸ‰ ê¸°ë°˜)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
reward = 0.0

# Time penalty ì™„í™” (ê¸°ì¡´ 0.01 â†’ 0.001)
reward -= 0.001

# 1. EE â†’ Cube ì ‘ê·¼ ë³´ìƒ (ê°œì„ ëŸ‰ ê¸°ë°˜)
if self.prev_ee_to_cube_dist is not None:
    ee_progress = self.prev_ee_to_cube_dist - dist_to_cube
    reward += 5.0 * ee_progress  # ê°€ê¹Œì›Œì§€ë©´ +, ë©€ì–´ì§€ë©´ -

# 2. Cube â†’ Target ì ‘ê·¼ ë³´ìƒ (grasp_valid ì‹œë§Œ, ê°œì„ ëŸ‰ ê¸°ë°˜)
if grasp_valid and self.prev_cube_to_target_dist is not None:
    cube_progress = self.prev_cube_to_target_dist - dist_cube_to_target
    reward += 4.0 * cube_progress  # ê°€ê¹Œì›Œì§€ë©´ +, ë©€ì–´ì§€ë©´ -

# ê±°ë¦¬ ì´ë ¥ ì—…ë°ì´íŠ¸
self.prev_ee_to_cube_dist = dist_to_cube
self.prev_cube_to_target_dist = dist_cube_to_target
```

### 3. ì´ë²¤íŠ¸ ë³´ìƒ ìƒí–¥ ì¡°ì •

```python
# 1ï¸âƒ£ ê·¼ì ‘ ë³´ìƒ: +5 â†’ +10
# 2ï¸âƒ£ ê·¸ë¦½ ë³´ìƒ: +10 â†’ +40
# 3ï¸âƒ£ ë¦¬í”„íŠ¸ ë³´ìƒ: +15 â†’ +50
# 4ï¸âƒ£ ëª©í‘œ ê·¼ì ‘ ë³´ìƒ: ì œê±° (LIFTì™€ SUCCESS ì‚¬ì´ ê°„ê²©ì´ í¬ì§€ ì•ŠìŒ)
# 5ï¸âƒ£ Success ë³´ìƒ: +100 (ìœ ì§€)
```

### 4. ë³´ìƒ í´ë¨í•‘ ì¶”ê°€

```python
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ C. REWARD CLIPPING (1ìŠ¤í… ë³´ìƒ ì œí•œ)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ìŠ¤íŒŒì´í¬ ë³´ìƒ ì œì™¸í•˜ê³  Dense ë³´ìƒë§Œ í´ë¨í•‘
if reward < 90.0:  # í° ì´ë²¤íŠ¸ ë³´ìƒ ì œì™¸
    reward = np.clip(reward, -2.0, 2.0)
```

### 5. ê·¸ë¦¬í¼ ì„ê³„ì¹˜ ì™„í™”

```python
# is_grasped: 0.02 â†’ 0.025 (2.5mm)
is_grasped = 1.0 if (ee_to_cube_dist < 0.08 and gripper_width < 0.025) else 0.0

# grasp_valid: 0.02 â†’ 0.025
grasp_valid = (
    dist_to_cube < 0.08 and
    gripper_width < 0.025 and  # ì™„í™”
    cube_pos[2] > 0.03
)
```

### 6. ë Œë”ë§ ë„ê¸° (í•™ìŠµ ì†ë„ í–¥ìƒ)

```python
# Physics ì‹œë®¬ë ˆì´ì…˜ ìŠ¤í… (í•™ìŠµ ì‹œ render=False ê¶Œì¥)
self.world.step(render=False)
```

### 7. ì—í”¼ì†Œë“œ í†µê³„ ì¶”ê°€

```python
# ë§ˆì¼ìŠ¤í†¤ ì¹´ìš´í„°
self.episode_reach_count = 0
self.episode_grip_count = 0
self.episode_lift_count = 0

# infoì— ì¶”ê°€
info = {
    ...
    "milestone_counts": {
        "reach": self.episode_reach_count,
        "grip": self.episode_grip_count,
        "lift": self.episode_lift_count,
    },
    "gripper": {
        "width": float(gripper_width),
        "is_grasped": float(is_grasped),
        "grip_frames": self.grip_frames,
    },
    ...
}
```

---

## ğŸ¯ ê¸°ëŒ€ íš¨ê³¼

### 1. ì„±ê³µ íŒì • ì‘ë™
- âœ… SUCCESS ì¡°ê±´ì´ ì˜¬ë°”ë¥´ê²Œ í‰ê°€ë¨
- âœ… ì¡°ê¸° ì¢…ë£Œ ê°€ëŠ¥ (l<600 ì—í”¼ì†Œë“œ ë°œìƒ)
- âœ… done_reasonì— "success" ë“±ì¥

### 2. í•™ìŠµ íš¨ìœ¨ í–¥ìƒ
- âœ… Î”í˜• ë³´ìƒìœ¼ë¡œ ëˆ„ì  ìŒìˆ˜ ì™„í™” (-600 â†’ -50 ì˜ˆìƒ)
- âœ… ì´ë²¤íŠ¸ ë³´ìƒ ìƒí–¥ìœ¼ë¡œ ë§ˆì¼ìŠ¤í†¤ í•™ìŠµ ê°•í™”
- âœ… ë³´ìƒ í´ë¨í•‘ìœ¼ë¡œ í•™ìŠµ ì•ˆì •ì„± â†‘

### 3. ê·¸ë¦¬í¼ ë™ì‘ ê°œì„ 
- âœ… ì„ê³„ì¹˜ ì™„í™”ë¡œ grasp ë‹¬ì„±ë¥  â†‘
- âœ… ì—í”¼ì†Œë“œ í†µê³„ë¡œ ë””ë²„ê¹… ìš©ì´

### 4. í•™ìŠµ ì†ë„ í–¥ìƒ
- âœ… render=Falseë¡œ FPS 2ë°° ì´ìƒ í–¥ìƒ (ì˜ˆìƒ: 100 FPS â†’ 200+ FPS)

---

## ğŸ“Š ê²€ì¦ ê³„íš

### 1. ì¦‰ì‹œ í™•ì¸ (10K í…ŒìŠ¤íŠ¸)
```bash
~/isaacsim/python.sh scripts/rl/train_dense_reward.py --timesteps 10000
```

**í™•ì¸ ì‚¬í•­**:
- [ ] monitor.csvì— **l<600 ì—í”¼ì†Œë“œ** ë“±ì¥
- [ ] done_reasonì— **"success"** ë“±ì¥
- [ ] í‰ê·  ë³´ìƒ ê°œì„  (-600 â†’ -150 ì´í•˜)
- [ ] reach/grip/lift ì¹´ìš´íŠ¸ ì¦ê°€

### 2. ì •ê·œ í•™ìŠµ (50K)
```bash
~/isaacsim/python.sh scripts/rl/train_dense_reward.py --timesteps 50000
```

**í™•ì¸ ì‚¬í•­**:
- [ ] ep_rew_mean: -280 â†’ -150 â†’ -50 â†’ 0 ì¶”ì„¸
- [ ] SUCCESS ë‹¬ì„± ì—í”¼ì†Œë“œ ë°œìƒ
- [ ] Phase 0â†’1 ìŠ¹ê¸‰ (ì„±ê³µë¥  30%)

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

1. **V5 10K í…ŒìŠ¤íŠ¸** (ìµœìš°ì„ ! âš ï¸)
   - ë²„ê·¸ ìˆ˜ì • íš¨ê³¼ ì¦‰ì‹œ í™•ì¸
   - l<600 ì—í”¼ì†Œë“œ ë°œìƒ ì—¬ë¶€

2. **V5 50K ì •ê·œ í•™ìŠµ**
   - ì™„ì „í•œ í•™ìŠµ ì‹¤í–‰
   - Phase ìŠ¹ê¸‰ í™•ì¸

3. **GUI í…ŒìŠ¤íŠ¸**
   - í•™ìŠµëœ ì •ì±… ì‹œê°í™”
   - SUCCESS ë‹¬ì„± í™•ì¸

4. **ì¶”ê°€ ê°œì„  ê²€í† ** (V5 ê²°ê³¼ ê¸°ë°˜)
   - EE ìœ„ì¹˜ ì¶”ì • ê°œì„  (ê·¼ì‚¬ FK â†’ ì •í™•í•œ ë§í¬ pose)
   - ê·¸ë¦¬í¼ íŒŒì´í”„ë¼ì¸ ì ê²€
   - ë³´ìƒ ìŠ¤ì¼€ì¼ ë¯¸ì„¸ ì¡°ì •

---

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ê´€ì¸¡ ë²¡í„° ì¸ë±ìŠ¤ ìˆ˜ì • (step, _check_done)
- [x] ì›”ë“œ ì¢Œí‘œ ì¬ê³„ì‚° ì¶”ê°€
- [x] Î”í˜• ë³´ìƒ êµ¬ì¡° ë³€ê²½
- [x] ì´ë²¤íŠ¸ ë³´ìƒ ìƒí–¥ ì¡°ì •
- [x] ë³´ìƒ í´ë¨í•‘ ì¶”ê°€
- [x] ê·¸ë¦¬í¼ ì„ê³„ì¹˜ ì™„í™”
- [x] ë Œë”ë§ ë„ê¸°
- [x] ì—í”¼ì†Œë“œ í†µê³„ ì¶”ê°€
- [ ] V5 10K í…ŒìŠ¤íŠ¸ ì‹¤í–‰
- [ ] ê²°ê³¼ ë¶„ì„ ë° ë¬¸ì„œí™”
- [ ] V5 50K ì •ê·œ í•™ìŠµ
- [ ] GUI í…ŒìŠ¤íŠ¸

---

## ğŸ† ê²°ë¡ 

ì´ ë²„ê·¸ëŠ” **V4 ê°œì„ ì˜ í•µì‹¬ ëª©í‘œ**ë¥¼ ì™„ì „íˆ ë¬´íš¨í™”ì‹œí‚¤ëŠ” ì¹˜ëª…ì ì¸ ë¬¸ì œì˜€ìŠµë‹ˆë‹¤. 

**V4ì˜ ì˜ë„**:
- SUCCESS ì¡°ê±´ ê°•í™” (2cm, 10í”„ë ˆì„)
- Phase ë‚œì´ë„ ìƒí–¥
- TimeLimit ëª…ì‹œì  ì„¤ì •

**ì‹¤ì œ ê²°ê³¼** (V4 ë²„ê·¸):
- SUCCESS ì¡°ê±´ì´ ì˜ëª»ëœ ê°’ìœ¼ë¡œ í‰ê°€ë¨
- ëª¨ë“  ì—í”¼ì†Œë“œê°€ TimeLimitìœ¼ë¡œ ì¢…ë£Œ
- ì •ì±…ì´ ì‹¤ì œ ëª©í‘œ ë‹¬ì„±ì„ í•™ìŠµí•˜ì§€ ëª»í•¨

**V5 ìˆ˜ì • í›„ ê¸°ëŒ€**:
- âœ… SUCCESS ì¡°ê±´ì´ ì˜¬ë°”ë¥´ê²Œ ì‘ë™
- âœ… ì¡°ê¸° ì¢…ë£Œ ê°€ëŠ¥ (l<600)
- âœ… í•™ìŠµ íš¨ìœ¨ ëŒ€í­ í–¥ìƒ
- âœ… ë§ˆì¼ìŠ¤í†¤ ê¸°ë°˜ í•™ìŠµ ì •ìƒí™”

ì´ì œ **V5 10K í…ŒìŠ¤íŠ¸**ë¥¼ ì‹¤í–‰í•˜ì—¬ ìˆ˜ì • íš¨ê³¼ë¥¼ ì¦‰ì‹œ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤! ğŸš€
